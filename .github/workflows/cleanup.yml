name: ðŸ§¹ Cleanup

on:
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ”Ñ‚ÑŒÑÑ Ñ‰Ð¾Ð´Ð½Ñ Ð¾ 2:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Ð”Ð¾Ð·Ð²Ð¾Ð»ÑÑ” Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚Ð¸ Ð²Ñ€ÑƒÑ‡Ð½Ñƒ

jobs:
  cleanup-artifacts:
    name: ðŸ—‘ï¸ Cleanup Build Artifacts
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ§¹ Delete old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const oldArtifacts = artifacts.data.artifacts.filter(artifact => {
              const ageInDays = (Date.now() - new Date(artifact.created_at)) / (1000 * 60 * 60 * 24);
              return ageInDays > 7; // Ð’Ð¸Ð´Ð°Ð»ÑÑ”Ð¼Ð¾ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¸ ÑÑ‚Ð°Ñ€ÑˆÑ– 7 Ð´Ð½Ñ–Ð²
            });
            
            console.log(`ðŸ—‘ï¸ Ð—Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ ${oldArtifacts.length} ÑÑ‚Ð°Ñ€Ð¸Ñ… Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ–Ð² Ð´Ð»Ñ Ð²Ð¸Ð´Ð°Ð»ÐµÐ½Ð½Ñ`);
            
            for (const artifact of oldArtifacts) {
              console.log(`Ð’Ð¸Ð´Ð°Ð»ÑÑ”Ð¼Ð¾: ${artifact.name} (${artifact.created_at})`);
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id
              });
            }
            
            console.log(`âœ… Ð’Ð¸Ð´Ð°Ð»ÐµÐ½Ð¾ ${oldArtifacts.length} ÑÑ‚Ð°Ñ€Ð¸Ñ… Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ–Ð²`);

  cleanup-caches:
    name: ðŸ§½ Cleanup Caches
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ§¹ Delete old caches
        uses: actions/github-script@v7
        with:
          script: |
            const caches = await github.rest.actions.getActionsCacheList({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const oldCaches = caches.data.actions_caches.filter(cache => {
              const ageInDays = (Date.now() - new Date(cache.created_at)) / (1000 * 60 * 60 * 24);
              return ageInDays > 7; // Ð’Ð¸Ð´Ð°Ð»ÑÑ”Ð¼Ð¾ ÐºÐµÑˆÑ– ÑÑ‚Ð°Ñ€ÑˆÑ– 7 Ð´Ð½Ñ–Ð²
            });
            
            console.log(`ðŸ—‘ï¸ Ð—Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ ${oldCaches.length} ÑÑ‚Ð°Ñ€Ð¸Ñ… ÐºÐµÑˆÑ–Ð² Ð´Ð»Ñ Ð²Ð¸Ð´Ð°Ð»ÐµÐ½Ð½Ñ`);
            
            for (const cache of oldCaches) {
              console.log(`Ð’Ð¸Ð´Ð°Ð»ÑÑ”Ð¼Ð¾ ÐºÐµÑˆ: ${cache.key} (${cache.created_at})`);
              await github.rest.actions.deleteActionsCacheById({
                owner: context.repo.owner,
                repo: context.repo.repo,
                cache_id: cache.id
              });
            }
            
            console.log(`âœ… Ð’Ð¸Ð´Ð°Ð»ÐµÐ½Ð¾ ${oldCaches.length} ÑÑ‚Ð°Ñ€Ð¸Ñ… ÐºÐµÑˆÑ–Ð²`);

  cleanup-old-workflows:
    name: ðŸ”„ Cleanup Old Workflow Runs
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ§¹ Delete old workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            const workflows = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
              status: 'completed'
            });
            
            const oldRuns = workflows.data.workflow_runs.filter(run => {
              const ageInDays = (Date.now() - new Date(run.created_at)) / (1000 * 60 * 60 * 24);
              return ageInDays > 30; // Ð’Ð¸Ð´Ð°Ð»ÑÑ”Ð¼Ð¾ Ð¿Ñ€Ð¾Ð³Ð¾Ð½Ð¸ ÑÑ‚Ð°Ñ€ÑˆÑ– 30 Ð´Ð½Ñ–Ð²
            });
            
            console.log(`ðŸ—‘ï¸ Ð—Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ ${oldRuns.length} ÑÑ‚Ð°Ñ€Ð¸Ñ… Ð¿Ñ€Ð¾Ð³Ð¾Ð½Ñ–Ð² Ð´Ð»Ñ Ð²Ð¸Ð´Ð°Ð»ÐµÐ½Ð½Ñ`);
            
            for (const run of oldRuns.slice(0, 20)) { // ÐžÐ±Ð¼ÐµÐ¶ÑƒÑ”Ð¼Ð¾ Ð´Ð¾ 20 Ð·Ð° Ñ€Ð°Ð·
              console.log(`Ð’Ð¸Ð´Ð°Ð»ÑÑ”Ð¼Ð¾ Ð¿Ñ€Ð¾Ð³Ð¾Ð½: ${run.name} #${run.run_number} (${run.created_at})`);
              await github.rest.actions.deleteWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: run.id
              });
            }
            
            console.log(`âœ… Ð’Ð¸Ð´Ð°Ð»ÐµÐ½Ð¾ ${Math.min(oldRuns.length, 20)} ÑÑ‚Ð°Ñ€Ð¸Ñ… Ð¿Ñ€Ð¾Ð³Ð¾Ð½Ñ–Ð²`);

  report:
    name: ðŸ“Š Cleanup Report
    runs-on: ubuntu-latest
    needs: [cleanup-artifacts, cleanup-caches, cleanup-old-workflows]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate cleanup report
        run: |
          echo "## ðŸ§¹ Cleanup Report"
          echo ""
          echo "**Date:** $(date)"
          echo "**Status:** Cleanup completed"
          echo ""
          echo "### Actions taken:"
          echo "- âœ… Cleaned up old build artifacts (>7 days)"
          echo "- âœ… Cleaned up old caches (>7 days)"
          echo "- âœ… Cleaned up old workflow runs (>30 days)"
          echo ""
          echo "### Benefits:"
          echo "- ðŸ’¾ Freed up storage space"
          echo "- âš¡ Improved repository performance"
          echo "- ðŸ”’ Better security (removed old artifacts)"