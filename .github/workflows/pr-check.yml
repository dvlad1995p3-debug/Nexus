name: ğŸ” PR Check

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  # Ğ”Ğ¶Ğ¾Ğ± Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸ ĞºĞ¾Ğ´Ñƒ
  check:
    name: ğŸ§ª Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ĞŸĞ¾Ğ²Ğ½Ğ¸Ğ¹ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ´Ğ»Ñ ĞºÑ€Ğ°Ñ‰Ğ¾Ğ³Ğ¾ Ğ°Ğ½Ğ°Ğ»Ñ–Ğ·Ñƒ
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¥ Install dependencies
        run: npm ci
        
      - name: ğŸ§¹ Lint check
        run: npm run lint
        
      - name: ğŸ—ï¸ Build check
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY || 'placeholder_key' }}

  # Ğ”Ğ¶Ğ¾Ğ± Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸ TypeScript
  typecheck:
    name: ğŸ“ TypeScript Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¥ Install dependencies
        run: npm ci
        
      - name: ğŸ” Type check
        run: npx tsc --noEmit
        continue-on-error: true # ĞĞµ Ğ±Ğ»Ğ¾ĞºÑƒÑ”Ğ¼Ğ¾ PR Ñ‡ĞµÑ€ĞµĞ· TypeScript Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ¸

  # Ğ”Ğ¶Ğ¾Ğ± Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸ Ğ¼Ñ–Ğ³Ñ€Ğ°Ñ†Ñ–Ğ¹ Supabase
  migration-check:
    name: ğŸ—„ï¸ Migration Validation
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, 'supabase/migrations/')
    
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ³ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
          
      - name: âœ… Validate migrations
        run: |
          echo "ğŸ” ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ğ¼Ñ–Ğ³Ñ€Ğ°Ñ†Ñ–Ñ—..."
          # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ ÑĞ¸Ğ½Ñ‚Ğ°ĞºÑĞ¸Ñ SQL Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ²
          find supabase/migrations -name "*.sql" -exec echo "Checking {}" \; -exec cat {} \;
          echo "âœ… ĞœÑ–Ğ³Ñ€Ğ°Ñ†Ñ–Ñ— Ğ¼Ğ°ÑÑ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¸Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚"

  # Ğ”Ğ¶Ğ¾Ğ± Ğ´Ğ»Ñ Ñ€Ğ¾Ğ·Ñ€Ğ°Ñ…ÑƒĞ½ĞºÑƒ Ñ€Ğ¾Ğ·Ğ¼Ñ–Ñ€Ñƒ Ğ·Ğ±Ñ–Ñ€ĞºĞ¸
  bundle-size:
    name: ğŸ“Š Bundle Size Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¥ Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build for analysis
        run: npm run build
        env:
          VITE_SUPABASE_URL: 'https://placeholder.supabase.co'
          VITE_SUPABASE_ANON_KEY: 'placeholder_key'
        
      - name: ğŸ“Š Analyze bundle size
        run: |
          echo "ğŸ“¦ Ğ Ğ¾Ğ·Ğ¼Ñ–Ñ€ Ğ·Ğ±Ñ–Ñ€ĞºĞ¸:"
          du -sh dist/
          echo ""
          echo "ğŸ“„ Ğ Ğ¾Ğ·Ğ¼Ñ–Ñ€ Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ²:"
          find dist/ -type f -name "*.js" -o -name "*.css" | head -10 | xargs ls -lh
          
      - name: ğŸ’¬ Comment bundle size
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ñ€Ğ¾Ğ·Ğ¼Ñ–Ñ€ Ğ·Ğ±Ñ–Ñ€ĞºĞ¸
            const { execSync } = require('child_process');
            const bundleSize = execSync('du -sh dist/', { encoding: 'utf8' }).trim();
            
            const comment = `
            ## ğŸ“Š Bundle Size Report
            
            **Total bundle size:** \`${bundleSize}\`
            
            ğŸ¯ **Tips for optimization:**
            - Use dynamic imports for large libraries
            - Optimize images and assets
            - Remove unused dependencies
            
            Built on: ${new Date().toISOString()}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ĞŸÑ–Ğ´ÑÑƒĞ¼ĞºĞ¾Ğ²Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ
  pr-status:
    name: ğŸ“‹ PR Status
    runs-on: ubuntu-latest
    needs: [check, typecheck, bundle-size]
    if: always()
    
    steps:
      - name: âœ… All checks passed
        if: needs.check.result == 'success' && needs.typecheck.result == 'success'
        run: |
          echo "ğŸ‰ Ğ’ÑÑ– Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ¹ÑˆĞ»Ğ¸ ÑƒÑĞ¿Ñ–ÑˆĞ½Ğ¾!"
          echo "âœ… ĞšĞ¾Ğ´ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ğ¹ Ğ´Ğ¾ Ğ¼ĞµÑ€Ğ¶Ñƒ"
          
      - name: âš ï¸ Some checks failed
        if: needs.check.result == 'failure' || needs.typecheck.result == 'failure'
        run: |
          echo "âš ï¸ Ğ”ĞµÑĞºÑ– Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸ Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ¹ÑˆĞ»Ğ¸"
          echo "ğŸ“‹ ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€Ñ‚Ğµ Ğ»Ğ¾Ğ³Ğ¸ Ñ‚Ğ° Ğ²Ğ¸Ğ¿Ñ€Ğ°Ğ²Ñ‚Ğµ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ¸"
          exit 1